<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel Administrativo | Casa da Impressora</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  background:#f4f6f8;
  margin:0;
}

header {
  background:#0b5ed7;
  color:#fff;
  text-align:center;
  padding:20px;
}

main {
  max-width:1100px;
  margin:20px auto;
  background:#fff;
  padding:20px;
  border-radius:10px;
}

table {
  width:100%;
  border-collapse: collapse;
}

th, td {
  border-bottom:1px solid #ddd;
  padding:10px;
  text-align:left;
  font-size:14px;
}

th {
  background:#f0f0f0;
}

button {
  padding:6px 10px;
  border:none;
  border-radius:4px;
  cursor:pointer;
}

.btn-print { background:#198754; color:#fff; }
.btn-del { background:#dc3545; color:#fff; }

.login-box {
  max-width:360px;
  margin:80px auto;
  background:#fff;
  padding:25px;
  border-radius:10px;
  box-shadow:0 0 10px rgba(0,0,0,.1);
}

.login-box input {
  width:100%;
  padding:10px;
  margin-top:10px;
}

.login-box button {
  width:100%;
  margin-top:15px;
  background:#0b5ed7;
  color:#fff;
  font-size:16px;
}
</style>
</head>

<body>

<div id="login" class="login-box">
  <h2>Acesso Administrativo</h2>
  <input id="user" placeholder="Usuário">
  <input id="pass" type="password" placeholder="Senha">
  <button onclick="login()">Entrar</button>
  <p id="loginErro" style="color:red;"></p>
</div>

<header id="topo" style="display:none;">
  <h1>Painel Administrativo</h1>
  <p>Casa da Impressora</p>
</header>

<main id="painel" style="display:none;">
  <h2>Agendamentos</h2>
  <table>
    <thead>
      <tr>
        <th>OS</th>
        <th>Data</th>
        <th>Cliente</th>
        <th>Telefone</th>
        <th>Equipamento</th>
        <th>Status</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody id="lista"></tbody>
  </table>
</main>

<script type="module">
import { db } from "./firebase.js";
import {
  collection, getDocs, doc, deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// LOGIN SIMPLES
window.login = function () {
  const u = document.getElementById("user").value;
  const p = document.getElementById("pass").value;

  if (u === "casa" && p === "imp153624") {
    document.getElementById("login").style.display = "none";
    document.getElementById("painel").style.display = "block";
    document.getElementById("topo").style.display = "block";
    carregar();
  } else {
    document.getElementById("loginErro").innerText = "Usuário ou senha inválidos";
  }
};

async function carregar() {
  const snap = await getDocs(collection(db,"agendamentos"));
  const tbody = document.getElementById("lista");
  tbody.innerHTML = "";

  snap.forEach(d => {
    const a = d.data();
    const os = a.osCodigo || "—";

    tbody.innerHTML += `
      <tr>
        <td><strong>${os}</strong></td>
        <td>${a.data}</td>
        <td>${a.nome}</td>
        <td>${a.telefone}</td>
        <td>${a.modelo}</td>
        <td>${a.status}</td>
        <td>
          <button class="btn-print" onclick='imprimir(${JSON.stringify(a)})'>Imprimir</button>
          <button class="btn-del" onclick="excluir('${d.id}')">Excluir</button>
        </td>
      </tr>
    `;
  });
}

window.excluir = async function(id) {
  if(confirm("Excluir este agendamento?")) {
    await deleteDoc(doc(db,"agendamentos",id));
    carregar();
  }
};

window.imprimir = function(a) {
  const w = window.open("", "_blank");

  w.document.write(`
  <html><head><title>OS ${a.osCodigo}</title>
  <style>
    body { font-family: Arial; margin:6mm; font-size:10px; }
    .via { border:1px solid #000; padding:8px; margin-bottom:6mm; }
    .titulo { text-align:center; font-weight:bold; font-size:12px; }
    .os { text-align:center; font-size:14px; font-weight:bold; margin:4px 0; }
    .linha { margin-bottom:3px; }
    .corte { border-top:2px dashed #000; margin:6mm 0; }
  </style>
  </head><body>

  <div class="via">
    <div class="titulo">VIA DA LOJA</div>
    <div class="os">${a.osCodigo}</div>
    <div class="linha"><b>Cliente:</b> ${a.nome}</div>
    <div class="linha"><b>Telefone:</b> ${a.telefone}</div>
    <div class="linha"><b>Equipamento:</b> ${a.modelo}</div>
    <div class="linha"><b>Tipo:</b> ${a.tipo}</div>
    <div class="linha"><b>Entrada:</b> ${a.data}</div>
    <div class="linha"><b>Problema:</b> ${a.problema || "-"}</div>
  </div>

  <hr class="corte">

  <div class="via">
    <div class="titulo">VIA DO CLIENTE</div>
    <div class="os">${a.osCodigo}</div>
    <div class="linha"><b>Cliente:</b> ${a.nome}</div>
    <div class="linha"><b>Equipamento:</b> ${a.modelo}</div>
    <div class="linha"><b>Entrada:</b> ${a.data}</div>
    <div class="linha">Assinatura: ____________________________</div>
  </div>

  </body></html>
  `);

  w.print();
};
</script>

</body>
</html>
