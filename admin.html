<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Painel Admin | Casa da Impressora</title>

<style>
  body { font-family: Arial, sans-serif; background:#f4f6f8; margin:0; }
  header { background:#0b5ed7; color:#fff; padding:18px; text-align:center; display:none; }
  main { max-width: 1100px; margin: 20px auto; padding: 0 14px; display:none; }
  .card { background:#fff; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,.08); padding:16px; margin-bottom:14px; }
  h2 { margin:0 0 10px; }
  .controls { display:flex; gap:10px; flex-wrap:wrap; align-items:end; }
  .controls .field { display:flex; flex-direction:column; gap:6px; }
  label { font-weight:700; font-size: 13px; color:#123; }
  input, select, button { padding:10px; border-radius:8px; border:1px solid #ccc; font-size:14px; }
  button { cursor:pointer; border:none; }
  .btn { background:#0b5ed7; color:#fff; font-weight:800; }
  .btn:hover { filter:brightness(.95); }
  .btn-ghost { background:#e9f2ff; color:#0b5ed7; font-weight:800; border:1px solid #bcd3ff; }
  .btn-danger { background:#e53935; color:#fff; font-weight:800; }
  .muted { color:#666; font-size:13px; }
  .table-wrap { overflow:auto; border-radius:10px; border:1px solid #e6e6e6; }
  table { width:100%; border-collapse:collapse; min-width: 1020px; background:#fff; }
  th, td { padding:10px; border-bottom:1px solid #eee; text-align:left; vertical-align:top; }
  th { background:#f7f9fc; position:sticky; top:0; z-index:1; }
  .pill { display:inline-block; padding:6px 10px; border-radius:999px; background:#f1f1f1; font-weight:800; font-size:12px; }
  .row-actions { display:flex; gap:8px; flex-wrap:wrap; }
  .small { font-size:12px; }
  .ok { color:#1b7f2a; font-weight:800; }
  .err { color:#b00020; font-weight:800; }

  /* ====== DIFERENCIA√á√ÉO VISUAL (N¬∫ 1) ====== */
  .tag {
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:5px 10px;
    border-radius:999px;
    font-weight:900;
    font-size:11px;
    border:1px solid;
    white-space:nowrap;
  }
  .tag-ag { background:#e9f2ff; color:#0b5ed7; border-color:#bcd3ff; }
  .tag-loc { background:#fff3e0; color:#b45309; border-color:#f7c68a; }

  /* linha de loca√ß√£o com ‚Äúcara de loca√ß√£o‚Äù */
  tr.loc-row td { background:#fffaf2; }
  tr.loc-row:hover td { background:#fff2db; }

  /* Login */
  #loginBox {
    max-width:520px;
    margin:40px auto;
    background:#fff;
    padding:18px;
    border-radius:12px;
    box-shadow:0 0 12px rgba(0,0,0,.08);
  }
  #loginBox h2 { margin:0 0 10px; }
  #loginBox .row { display:flex; flex-direction:column; gap:6px; margin-top:12px; }
  #loginBtn { width:100%; padding:12px; border-radius:10px; background:#0b5ed7; color:#fff; font-weight:900; }
  #logoutBtn {
    margin-top:10px;
    padding:10px 14px;
    border-radius:10px;
    border:1px solid rgba(255,255,255,.6);
    background:transparent;
    color:#fff;
    font-weight:900;
    cursor:pointer;
    margin-left:10px;
  }
</style>
</head>

<body>

<!-- LOGIN / SENHA -->
<div id="loginBox">
  <h2>Acesso do Administrador</h2>
  <p class="muted" style="margin:0;">Digite usu√°rio e senha para acessar o painel.</p>

  <div class="row">
    <label for="user">Usu√°rio</label>
    <input id="user" value="casa" autocomplete="username" />
  </div>

  <div class="row">
    <label for="pass">Senha</label>
    <input id="pass" type="password" placeholder="Sua senha" autocomplete="current-password" />
  </div>

  <button id="loginBtn">Entrar</button>
  <p id="loginMsg" class="err" style="margin:12px 0 0;"></p>

  <p class="muted small" style="margin-top:12px;">
    Dica: depois de logar, voc√™ fica logado por 12 horas neste navegador.
  </p>
</div>

<header id="hdr">
  <div style="display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:wrap;">
    <div>
      <h1 style="margin:0;">Painel Administrativo</h1>
      <div class="muted" style="color:rgba(255,255,255,.9);">Casa da Impressora ‚Ä¢ Agendamentos + Loca√ß√µes</div>
    </div>
    <button id="logoutBtn">Sair</button>
  </div>
</header>

<main id="main">
  <div class="card">
    <h2>Filtros</h2>
    <div class="controls">
      <div class="field">
        <label for="filtroData">Data (opcional)</label>
        <input type="date" id="filtroData" />
      </div>

      <div class="field" style="min-width:260px; flex:1;">
        <label for="busca">Buscar (nome/telefone/modelo/OS/LOC)</label>
        <input type="text" id="busca" placeholder="Ex: Samuel / 8899 / L3150 / OS-0007 / LOC-0001" />
      </div>

      <div class="field">
        <label for="tipoFiltro">Tipo</label>
        <select id="tipoFiltro">
          <option value="">Tudo</option>
          <option value="agendamento">Agendamento</option>
          <option value="locacao">Loca√ß√£o</option>
        </select>
      </div>

      <div class="field">
        <label for="statusFiltro">Status</label>
        <select id="statusFiltro">
          <option value="">Todos</option>

          <!-- Agendamento -->
          <option>Recebido</option>
          <option>Em avalia√ß√£o</option>
          <option>Or√ßamento enviado</option>
          <option>Aguardando aprova√ß√£o</option>
          <option>Aprovado</option>
          <option>Reprovado</option>
          <option>Conclu√≠do</option>

          <!-- Loca√ß√£o -->
          <option>Proposta enviada</option>
          <option>Em an√°lise</option>
          <option>Contrato enviado</option>
          <option>Contrato assinado</option>
          <option>Em entrega</option>
          <option>Ativo</option>
          <option>Cancelado</option>
        </select>
      </div>

      <button class="btn" id="btnRecarregar">Recarregar</button>
      <button class="btn-ghost" id="btnLimpar">Limpar filtros</button>
    </div>

    <div style="margin-top:12px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
      <div class="muted" id="info">Carregando...</div>
      <div class="muted" id="statusMsg"></div>
    </div>
  </div>

  <div class="card">
    <h2>Registros</h2>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Tipo / C√≥digo / Data</th>
            <th>Cliente</th>
            <th>Contato</th>
            <th>Equipamento / Plano</th>
            <th>Detalhes</th>
            <th>Status</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="7" class="muted">Carregando...</td></tr>
        </tbody>
      </table>
    </div>
    <p class="muted small" style="margin-top:10px;">
      Dica: altere o status e clique em <strong>Salvar</strong>. Loca√ß√µes ficam destacadas.
    </p>
  </div>
</main>

<script type="module">
import { db } from "./firebase.js";
import {
  collection, getDocs, query, orderBy, doc, updateDoc, deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ======================
   LOGIN/SENHA
   ====================== */
const USER_OK = "casa";
// HASH SHA-256 da senha "imp153624"
const PASS_HASH_OK = "f3dc22619a2e17bdc8ce3ca5419002320d2b596eb1829d341a321c596e9fca5d";

const SESSION_KEY = "admin_session_v3";
const SESSION_HOURS = 12;

const loginBox = document.getElementById("loginBox");
const hdr = document.getElementById("hdr");
const main = document.getElementById("main");
const loginMsg = document.getElementById("loginMsg");

const userEl = document.getElementById("user");
const passEl = document.getElementById("pass");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");

async function sha256(text) {
  const enc = new TextEncoder().encode(text);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,"0")).join("");
}

function setLoggedIn(on) {
  loginBox.style.display = on ? "none" : "block";
  hdr.style.display = on ? "block" : "none";
  main.style.display = on ? "block" : "none";
}

function saveSession() {
  const until = Date.now() + SESSION_HOURS * 60 * 60 * 1000;
  localStorage.setItem(SESSION_KEY, String(until));
}

function hasSession() {
  const until = Number(localStorage.getItem(SESSION_KEY) || "0");
  return until && Date.now() < until;
}

logoutBtn.addEventListener("click", () => {
  localStorage.removeItem(SESSION_KEY);
  location.reload();
});

loginBtn.addEventListener("click", async () => {
  loginMsg.textContent = "";
  const u = (userEl.value || "").trim();
  const p = passEl.value || "";

  if (u !== USER_OK) {
    loginMsg.textContent = "Usu√°rio inv√°lido.";
    return;
  }

  const hash = await sha256(p);
  if (hash !== PASS_HASH_OK) {
    loginMsg.textContent = "Senha incorreta.";
    return;
  }

  saveSession();
  setLoggedIn(true);
  carregar();
});

passEl.addEventListener("keydown", (e) => {
  if (e.key === "Enter") loginBtn.click();
});

if (hasSession()) {
  setLoggedIn(true);
  carregar();
} else {
  setLoggedIn(false);
}

/* ======================
   PAINEL
   ====================== */
const tbody = document.getElementById("tbody");
const info = document.getElementById("info");
const statusMsg = document.getElementById("statusMsg");

const filtroData = document.getElementById("filtroData");
const busca = document.getElementById("busca");
const statusFiltro = document.getElementById("statusFiltro");
const tipoFiltro = document.getElementById("tipoFiltro");
const btnRecarregar = document.getElementById("btnRecarregar");
const btnLimpar = document.getElementById("btnLimpar");

const STATUS_AGENDAMENTO = [
  "Recebido","Em avalia√ß√£o","Or√ßamento enviado","Aguardando aprova√ß√£o","Aprovado","Reprovado","Conclu√≠do"
];
const STATUS_LOCACAO = [
  "Proposta enviada","Em an√°lise","Contrato enviado","Contrato assinado","Em entrega","Ativo","Cancelado"
];

function setMsg(texto, tipo="") {
  statusMsg.className = tipo === "ok" ? "ok" : tipo === "err" ? "err" : "muted";
  statusMsg.textContent = texto || "";
}

function normalizar(str) {
  return (str || "").toString().toLowerCase();
}

function escapeHtml(str) {
  return (str ?? "")
    .toString()
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function limparTabela(mensagem="Carregando...") {
  tbody.innerHTML = `<tr><td colspan="7" class="muted">${mensagem}</td></tr>`;
}

function montarSelectStatus(valorAtual, tipo) {
  const lista = (tipo === "locacao") ? STATUS_LOCACAO : STATUS_AGENDAMENTO;
  const val = valorAtual && lista.includes(valorAtual) ? valorAtual : (lista[0] || "");
  return `
    <select class="statusSelect" data-tipo="${tipo}">
      ${lista.map(s => `<option ${s===val ? "selected":""}>${s}</option>`).join("")}
    </select>
  `;
}

/* =========== IMPRESS√ÉO 2 VIAS (somente agendamento) =========== */
function imprimirOS2Vias(dados, id) {
  const logoUrl = new URL("./logo.png", window.location.href).toString();

  const osCurta = escapeHtml(dados.osCodigo || `OS-${id.slice(0,6).toUpperCase()}`);
  const cliente = escapeHtml(dados.nome || "");
  const telefone = escapeHtml(dados.telefone || "");
  const dataEntrega = escapeHtml(dados.data || "");
  const modelo = escapeHtml(dados.modelo || "");
  const tipo = escapeHtml(dados.tipo || "");
  const problema = escapeHtml(dados.problema || "N√£o informado");
  const status = escapeHtml(dados.status || "Recebido");

  const osHtml = (tituloVia) => `
    <div class="via">
      <div class="via-title">${tituloVia}</div>

      <div class="top">
        <div class="brand">
          <img src="${logoUrl}" alt="Casa da Impressora"/>
          <div>
            <div style="font-weight:900; font-size:14px;">Casa da Impressora</div>
            <div style="font-size:10.5px; color:#333;">Assist√™ncia T√©cnica em Impress√£o</div>
            <div style="font-size:10.5px; color:#333;">WhatsApp: (88) 99368-7542</div>
          </div>
        </div>

        <div class="title">
          <h1>ORDEM DE SERVI√áO</h1>
          <div class="small">N¬∫ OS: <span class="pill">${osCurta}</span></div>
          <div class="small">Status: <span class="pill">${status}</span></div>
        </div>
      </div>

      <div class="grid">
        <div class="box">
          <h3>Dados do Cliente</h3>
          <div class="line"><span class="label">Cliente:</span> ${cliente}</div>
          <div class="line"><span class="label">Telefone:</span> ${telefone}</div>
          <div class="line"><span class="label">Data de entrega:</span> ${dataEntrega}</div>
        </div>

        <div class="box">
          <h3>Equipamento</h3>
          <div class="line"><span class="label">Modelo:</span> ${modelo}</div>
          <div class="line"><span class="label">Tipo:</span> ${tipo}</div>
          <div class="line"><span class="label">Acess√≥rios:</span> __________________________</div>
          <div class="line"><span class="label">Senha/Pin:</span> __________________________</div>
        </div>

        <div class="box big">
          <h3>Problema informado</h3>
          <div class="line">${problema}</div>
        </div>

        <div class="box big2">
          <h3>Observa√ß√µes t√©cnicas (preencher na loja)</h3>
          <div class="line">______________________________________________________________</div>
          <div class="line">______________________________________________________________</div>
          <div class="line">______________________________________________________________</div>
        </div>
      </div>

      <div class="note">
        <strong>Prazo para avalia√ß√£o e or√ßamento:</strong> at√© ______ dia(s) √∫til(eis) ap√≥s a entrega.
      </div>

      <div class="box" style="margin-top:6px;">
        <h3>Condi√ß√µes</h3>
        <div class="terms">
          1) O or√ßamento ser√° realizado ap√≥s avalia√ß√£o t√©cnica. <br/>
          2) Pe√ßas e servi√ßos somente mediante aprova√ß√£o do cliente. <br/>
          3) Equipamentos n√£o retirados em at√© 30 dias ap√≥s conclus√£o podem gerar taxa de armazenamento. <br/>
          4) Caso o servi√ßo n√£o seja aprovado, poder√° ser cobrada taxa de diagn√≥stico (se aplic√°vel).
        </div>
      </div>

      <div class="sign">
        <div class="sigline">Assinatura do Cliente</div>
        <div class="sigline">Assinatura / Respons√°vel T√©cnico</div>
      </div>

      <div class="footer">
        <div>Data: ____/____/______</div>
        <div>OS: ${osCurta}</div>
      </div>
    </div>
  `.trim();

  const html = `
<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>OS ${osCurta} (2 vias)</title>
<style>
  @page { size: A4; margin: 6mm; }
  body { font-family: Arial, sans-serif; color:#111; margin:0; }
  .wrap { border: 2px solid #111; padding: 5mm; border-radius: 8px; }
  .via { page-break-inside: avoid; }
  .via-title { font-weight:900; font-size:12px; margin-bottom:6px; }
  .top { display:flex; gap:10px; align-items:flex-start; justify-content:space-between; }
  .brand { display:flex; gap:10px; align-items:center; }
  .brand img { width: 78px; height:auto; }
  .title { text-align:right; }
  .title h1 { margin:0; font-size: 15px; }
  .title .small { font-size: 10px; color:#333; margin-top:3px; }
  .grid { display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:8px; }
  .box { border:1px solid #111; border-radius:8px; padding:7px; }
  .box h3 { margin:0 0 5px 0; font-size: 11px; }
  .line { margin: 3px 0; font-size: 10.5px; }
  .label { font-weight: 700; }
  .big { min-height: 52px; }
  .big2 { min-height: 62px; }
  .terms { font-size: 9.6px; color:#222; line-height:1.25; }
  .sign { display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:8px; }
  .sign .sigline { margin-top:14px; border-top:1px solid #111; padding-top:5px; font-size: 10px; }
  .footer { margin-top:6px; font-size: 10px; color:#333; display:flex; justify-content:space-between; }
  .pill { display:inline-block; padding:2px 8px; border:1px solid #111; border-radius:999px; font-weight:700; font-size:10px; }
  .note { font-size: 10px; margin-top:6px; }
  .corte { border:0; border-top:2px dashed #111; margin:8px 0; }
  .no-print { margin-top:8px; display:flex; gap:10px; }
  button { padding:8px 12px; border-radius:8px; border:1px solid #111; background:#fff; font-weight:800; cursor:pointer; font-size: 12px; }
  .primary { background:#0b5ed7; color:#fff; border-color:#0b5ed7; }
  @media print { .no-print { display:none; } }
</style>
</head>
<body>
  <div class="wrap">
    ${osHtml("VIA DA LOJA")}
    <hr class="corte"/>
    ${osHtml("VIA DO CLIENTE")}

    <div class="no-print">
      <button class="primary" onclick="window.print()">Imprimir</button>
      <button onclick="window.close()">Fechar</button>
    </div>
  </div>
</body>
</html>
  `.trim();

  const w = window.open("", "_blank", "width=900,height=700");
  w.document.open();
  w.document.write(html);
  w.document.close();
  w.focus();
}

/* ====== CARREGAR UNIFICADO ====== */
async function carregar() {
  setMsg("");
  limparTabela("Carregando...");
  info.textContent = "Carregando do Firestore...";

  try {
    const termo = normalizar(busca.value);
    const dataFiltrada = filtroData.value || "";
    const statusFiltrado = statusFiltro.value || "";
    const tipoFiltrado = tipoFiltro.value || ""; // "" | "agendamento" | "locacao"

    const itens = [];

    // AGENDAMENTOS
    if (!tipoFiltrado || tipoFiltrado === "agendamento") {
      const qAg = query(collection(db, "agendamentos"), orderBy("criadoEm", "desc"));
      const snapAg = await getDocs(qAg);
      snapAg.forEach((d) => {
        const dados = d.data();
        const id = d.id;
        itens.push({
          tipo: "agendamento",
          id,
          criadoEm: dados.criadoEm?.toMillis?.() || 0,
          data: dados.data || "",
          nome: dados.nome || "",
          telefone: dados.telefone || "",
          modelo: dados.modelo || "",
          tipoEquip: dados.tipo || "",
          detalhes: dados.problema || "",
          status: dados.status || "Recebido",
          codigo: dados.osCodigo || `OS-${id.slice(0,6).toUpperCase()}`
        });
      });
    }

    // LOCA√á√ïES
    if (!tipoFiltrado || tipoFiltrado === "locacao") {
      const qLoc = query(collection(db, "locacoes"), orderBy("criadoEm", "desc"));
      const snapLoc = await getDocs(qLoc);
      snapLoc.forEach((d) => {
        const dados = d.data();
        const id = d.id;

        const paginasMes = dados.paginasMes ?? dados.paginas ?? "";
        const totalMensal = dados.totalMensal ?? "";
        const detalheLoc = [
          paginasMes ? `P√°ginas/m√™s: ${paginasMes}` : "",
          totalMensal !== "" ? `Total estimado: R$ ${Number(totalMensal).toFixed(2)}` : ""
        ].filter(Boolean).join(" ‚Ä¢ ");

        itens.push({
          tipo: "locacao",
          id,
          criadoEm: dados.criadoEm?.toMillis?.() || 0,
          data: dados.data || dados.dataSolicitacao || "",
          nome: dados.nome || dados.cliente || "",
          telefone: dados.telefone || dados.whatsapp || "",
          modelo: dados.modelo || "HP OfficeJet Pro 8610",
          tipoEquip: "Loca√ß√£o ‚Ä¢ R$ 500/m√™s",
          detalhes: detalheLoc || (dados.obs || dados.observacoes || ""),
          status: dados.status || "Proposta enviada",
          codigo: dados.locacaoCodigo || `LOC-${id.slice(0,6).toUpperCase()}`
        });
      });
    }

    // ordena por mais recente
    itens.sort((a,b) => (b.criadoEm||0) - (a.criadoEm||0));

    // filtros locais
    const filtrados = itens.filter((it) => {
      if (dataFiltrada && (it.data || "") !== dataFiltrada) return false;
      if (statusFiltrado && (it.status || "") !== statusFiltrado) return false;
      if (termo) {
        const hay = normalizar([
          it.tipo, it.codigo, it.data, it.nome, it.telefone,
          it.modelo, it.tipoEquip, it.detalhes, it.status
        ].join(" "));
        if (!hay.includes(termo)) return false;
      }
      return true;
    });

    if (!filtrados.length) {
      limparTabela("Nenhum registro encontrado com esses filtros.");
      info.textContent = "0 resultados.";
      return;
    }

    const rows = filtrados.map((it) => {
      const isLoc = it.tipo === "locacao";
      const tag = isLoc
        ? `<span class="tag tag-loc">üè∑Ô∏è LOCA√á√ÉO</span>`
        : `<span class="tag tag-ag">üõ†Ô∏è AGENDAMENTO</span>`;

      const tel = (it.telefone || "").replace(/\D/g, "");
      const telWpp = tel.startsWith("55") ? tel : (tel ? "55" + tel : "");
      const msgWpp = encodeURIComponent(
        `Ol√°, ${it.nome || ""}! Aqui √© da Casa da Impressora.\n\n${isLoc ? "Loca√ß√£o" : "OS"}: ${it.codigo}\nStatus: ${it.status || ""}\n\nSe precisar, responda por aqui.`
      );

      const dataJson = escapeHtml(JSON.stringify({
        nome: it.nome, telefone: it.telefone, data: it.data,
        modelo: it.modelo, tipo: it.tipoEquip, problema: it.detalhes,
        status: it.status, osCodigo: isLoc ? "" : it.codigo, codigo: it.codigo
      }));

      return `
        <tr class="${isLoc ? "loc-row" : ""}" data-id="${it.id}" data-tipo="${it.tipo}" data-json="${dataJson}">
          <td>
            ${tag}
            <div style="margin-top:6px;">
              <span class="pill">${escapeHtml(it.codigo)}</span>
            </div>
            <div class="muted small" style="margin-top:6px;">üìÖ ${escapeHtml(it.data || "-")}</div>
          </td>

          <td><strong>${escapeHtml(it.nome || "-")}</strong></td>

          <td>
            <div>${escapeHtml(it.telefone || "-")}</div>
            ${telWpp ? `<a class="small" href="https://wa.me/${telWpp}?text=${msgWpp}" target="_blank">Abrir WhatsApp</a>` : ""}
          </td>

          <td>
            <div><strong>${escapeHtml(it.modelo || "-")}</strong></div>
            <div class="muted small">${escapeHtml(it.tipoEquip || "-")}</div>
          </td>

          <td class="small">${escapeHtml(it.detalhes || "‚Äî")}</td>

          <td>
            ${montarSelectStatus(it.status, it.tipo)}
          </td>

          <td>
            <div class="row-actions">
              ${isLoc ? "" : `<button class="btn-ghost imprimirBtn">Imprimir 2 vias</button>`}
              <button class="btn salvarBtn">Salvar</button>
              <button class="btn-danger excluirBtn">Excluir</button>
            </div>
          </td>
        </tr>
      `;
    });

    tbody.innerHTML = rows.join("");
    info.textContent = `${filtrados.length} registro(s) exibido(s).`;
  } catch (err) {
    console.error(err);
    limparTabela("Erro ao carregar. Veja o Console (F12).");
    info.textContent = "Erro ao carregar.";
    setMsg("Erro ao ler Firestore. Confira regras/permiss√µes.", "err");
  }
}

tbody.addEventListener("click", async (e) => {
  const tr = e.target.closest("tr[data-id]");
  if (!tr) return;

  const id = tr.getAttribute("data-id");
  const tipo = tr.getAttribute("data-tipo");
  const select = tr.querySelector(".statusSelect");
  const col = (tipo === "locacao") ? "locacoes" : "agendamentos";

  if (e.target.classList.contains("imprimirBtn")) {
    try {
      const json = tr.getAttribute("data-json") || "{}";
      const dados = JSON.parse(json);
      dados.status = select?.value || dados.status || "Recebido";
      imprimirOS2Vias(dados, id);
    } catch (err) {
      console.error(err);
      setMsg("Erro ao gerar OS (veja Console F12)", "err");
    }
    return;
  }

  if (e.target.classList.contains("salvarBtn")) {
    const novoStatus = select?.value || "";
    try {
      await updateDoc(doc(db, col, id), { status: novoStatus });
      setMsg("Status atualizado com sucesso ‚úÖ", "ok");
      await carregar();
    } catch (err) {
      console.error(err);
      setMsg("Erro ao salvar status ‚ùå (veja Console F12)", "err");
    }
  }

  if (e.target.classList.contains("excluirBtn")) {
    const ok = confirm("Tem certeza que deseja excluir esse registro?");
    if (!ok) return;

    try {
      await deleteDoc(doc(db, col, id));
      setMsg("Registro exclu√≠do ‚úÖ", "ok");
      await carregar();
    } catch (err) {
      console.error(err);
      setMsg("Erro ao excluir ‚ùå (veja Console F12)", "err");
    }
  }
});

btnRecarregar.addEventListener("click", carregar);

btnLimpar.addEventListener("click", () => {
  filtroData.value = "";
  busca.value = "";
  statusFiltro.value = "";
  tipoFiltro.value = "";
  carregar();
});

busca.addEventListener("input", () => {
  clearTimeout(window.__t);
  window.__t = setTimeout(() => carregar(), 250);
});

filtroData.addEventListener("change", carregar);
statusFiltro.addEventListener("change", carregar);
tipoFiltro.addEventListener("change", carregar);
</script>

</body>
</html>
